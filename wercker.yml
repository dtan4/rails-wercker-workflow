box:
  id: quay.io/dtan4/rails-test-base
  tag: latest
  registry: quay.io

services:
  - postgres:9.4

build:
  steps:
    - script:
        name: Show global envs
        code: env
    - script:
        name: Show dir
        code: |
          ls -al $WERCKER_ROOT
          echo "===================="
          ls -al $WERCKER_OUTPUT_DIR
    - script:
        name: Save start time
        code: |
          echo $WERCKER_MAIN_PIPELINE_STARTED > main_pipeline_started
          cp -r * $WERCKER_OUTPUT_DIR/

rspec-models:
  steps:
    - script:
        name: Show dir
        code: |
          ls -al $WERCKER_ROOT
          echo "===================="
          ls -al $WERCKER_OUTPUT_DIR
    - script:
        name: Show global envs
        code: env
    - bundle-install
    - script:
        name: Set POSTGRES_USER
        code: export POSTGRES_USER=postgres
    - script:
        name: Show dir
        code: |
          ls -al $WERCKER_ROOT
          echo "===================="
          ls -al $WERCKER_OUTPUT_DIR
    - script:
        name: Prepare database
        code: bundle exec rake db:test:prepare
    - script:
        name: Run RSpec
        code: bundle exec rspec spec/models
    - script:
        name: Show total time
        code: script/calculate-total-time

rspec-controllers:
  steps:
    - script:
        name: Show dir
        code: |
          ls -al $WERCKER_ROOT
          echo "===================="
          ls -al $WERCKER_OUTPUT_DIR
    - script:
        name: Show global envs
        code: env
    - bundle-install
    - script:
        name: Set POSTGRES_USER
        code: export POSTGRES_USER=postgres
    - script:
        name: Prepare database
        code: bundle exec rake db:test:prepare
    - script:
        name: Run RSpec
        code: bundle exec rspec spec/controllers
    - script:
        name: Show total time
        code: script/calculate-total-time

rspec-features:
  steps:
    - script:
        name: Show dir
        code: |
          ls -al $WERCKER_ROOT
          echo "===================="
          ls -al $WERCKER_OUTPUT_DIR
    - script:
        name: Show global envs
        code: env
    - bundle-install
    - script:
        name: Set POSTGRES_USER
        code: export POSTGRES_USER=postgres
    - script:
        name: Prepare database
        code: bundle exec rake db:test:prepare
    - script:
        name: Run RSpec
        code: bundle exec rspec spec/features
    - script:
        name: Show total time
        code: script/calculate-total-time
